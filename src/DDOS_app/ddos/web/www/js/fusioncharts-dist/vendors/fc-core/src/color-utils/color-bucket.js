import{parseUnsafeString,pluckNumber,pluck,extend2,COLOR_BLACK}from'../lib';import{ComponentInterface}from'../component-interface';let UNDEF,getTransitColor=function(a,b,c){let d=a[0],e=a[1],f=a[2],g=d+(b[0]-d)*c,h=e+(b[1]-e)*c,i=f+(b[2]-f)*c;return{hex:(COLOR_BLACK+(g<<16|h<<8|i).toString(16)).slice(-6),rgb:[g,h,i]}};class ColorBucket extends ComponentInterface{constructor(){super();let a=this;a.mapByCategory=!1,a.colorArr=[],a.noValidRange=!0,a.sortLegend=!1}__setDefaultConfig(){super.__setDefaultConfig(),this.config.defaultObj={code:'CCCCCC',alpha:'100'}}getType(){return'colorComponent'}getName(){return'colorBucket'}configure(a){if(!a)return;let b,c,d,e,f,g,h,j,k,l,m,n=this,o=n.mapByCategory,p=a.numberFormatter,q=a.colorRange||{},r=extend2([],q.color),s=this.getLinkedParent(),t=n.getFromEnv('dataSource'),u=Math.min(Math.max(pluckNumber(t.chart.palette,0)-1,0),4),v=s.defaultPaletteOptions&&s.defaultPaletteOptions.paletteColors[u],w=pluckNumber(p.getCleanValue(q.maxvalue),1/0),x=pluckNumber(p.getCleanValue(q.minvalue),-Infinity),y=n.colorArr;if(a.mapByCategory!==UNDEF&&(o=n.mapByCategory=!!+a.mapByCategory),r=o?r.filter(a=>a.code||a.color):r.filter(a=>a.minvalue||a.maxvalue),r.forEach(a=>{a.minvalue&&a.maxvalue&&+a.maxvalue<+a.minvalue&&(j=a.maxvalue,a.maxvalue=a.minvalue,a.minvalue=j),a.minvalue?a.maxvalue?(l=p.getCleanValue(a.minvalue),k=p.getCleanValue(a.maxvalue),a.rangeLabel=p.dataLabels(l)+'-'+p.dataLabels(k)):(l=p.getCleanValue(a.minvalue),a.maxvalue=k=w,a.rangeLabel=k===1/0?'>'+p.dataLabels(l):p.dataLabels(l)+'-'+p.dataLabels(k)):(a.minvalue=l=x,k=p.getCleanValue(a.maxvalue),a.rangeLabel=l===-Infinity?'<'+p.dataLabels(k):p.dataLabels(l)+'-'+p.dataLabels(k))}),r.sort((a,b)=>+a.minvalue==+b.minvalue?a.maxvalue-b.maxvalue:a.minvalue-b.minvalue),r&&(b=r.length)){for(y.length=0,c=0;c<b;c+=1)h=r[c],d=pluck(h.color,h.code,v&&v[c]),e=pluck(h.alpha),g=pluck(h.bordercolor),f=pluck(h.borderalpha,100),k=pluckNumber(h.maxvalue),l=pluckNumber(h.minvalue),m=pluck(h.label,h.displayvalue,h.rangeLabel),(d&&k>=l||o&&m)&&y.push({code:d,alpha:e||'100',oriAlpha:e,maxvalue:k,minvalue:l,label:parseUnsafeString(m),labelId:m.toLowerCase(),bordercolor:g,borderAlpha:f,name:h.name});n.sortedColorArr=n.colorArr.slice(0)}else n.noValidRange=!0,n.colorArr=[],n.sortedColorArr=[]}getColorObj(a){if(a===UNDEF)return{outOfRange:!0};let b,c,d=this,e=d.sortedColorArr,f=d.gradient?1:0,g=e[f];if(d.mapByCategory){for(a=parseUnsafeString(a).toLowerCase()||a.toString().toLowerCase();g;){if(g.labelId===a||g.maxvalue>=a&&g.minvalue<=a)return{code:g.code,alpha:g.alpha||'100',oriAlpha:g.oriAlpha,seriesIndex:f,legendItemId:g.legendItemId};f+=1,g=e[f]}return{outOfRange:!0}}if(d.gradient){if(d.scaleMin<=a&&d.scaleMax>=a){for(;g&&g.maxvalue<a;)f+=1,g=e[f];return c=(a-g.minvalue)/g.range,{code:getTransitColor(e[f-1].codeRGB,g.codeRGB,c).hex}}return{outOfRange:!0}}for(;g;){if(a<g.minvalue&&!b)return 0==f?{code:g.code,alpha:g.alpha||'100',oriAlpha:g.oriAlpha,seriesIndex:f,name:g.name,label:g.label,outOfRange:!0,bordercolor:g.bordercolor,borderalpha:g.borderAlpha}:{code:e[f-1].code,alpha:e[f-1].alpha||'100',oriAlpha:e[f-1].oriAlpha,seriesIndex:f,name:e[f-1].name,label:e[f-1].label,outOfRange:!0,bordercolor:e[f-1].bordercolor,borderalpha:e[f-1].borderAlpha};if(a>g.maxvalue&&f==e.length-1)return{code:g.code,alpha:g.alpha||'100',oriAlpha:g.oriAlpha,seriesIndex:f,name:g.name,label:g.label,outOfRange:!0,bordercolor:g.bordercolor,borderalpha:g.borderAlpha};if(g.maxvalue>a&&g.minvalue<=a)return{code:g.code,alpha:g.alpha||'100',oriAlpha:g.oriAlpha,seriesIndex:f,name:g.name,label:g.label,bordercolor:g.bordercolor,borderalpha:g.borderAlpha};if(a===g.maxvalue&&(b={code:g.code,alpha:g.alpha||'100',oriAlpha:g.oriAlpha,seriesIndex:f,name:g.name,label:g.label,bordercolor:g.bordercolor,borderalpha:g.borderAlpha}),f==e.length-1&&b)return b;f+=1,g=e[f]}if(!e.length)return{outOfRange:!0}}getColorRangeArr(a,b){var c,d,e,f,g,h,j,k,m=this.colorArr,n=[];if(!this.defaultAsigned&&(a>b&&(c=a,a=b,b=c),a<b&&(f=this.getColorObj(a),h=this.getColorObj(b),f&&h))){for(g=a,d=f.seriesIndex,e=h.seriesIndex;d<=e;d+=1)j=extend2({},m[d]),j.minvalue!==g&&(j.minvalue=g),n.push(j),k=j,g=j.maxvalue;k&&(k.maxvalue=b)}return n}}export default ColorBucket;