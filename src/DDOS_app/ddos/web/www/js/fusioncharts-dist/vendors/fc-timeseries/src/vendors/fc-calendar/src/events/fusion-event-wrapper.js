import Mapper from'./mapper.js';import isAllDefined from'./is-all-defined.js';let lastHoveredInfo={elementInfo:[]},safePointerEventMapping={mouseover:'pointerover',mousedown:'pointerdown',mousemove:'pointermove',mouseup:'pointerup',mouseout:'pointerout'},safeMouseEventMapping={mouseover:'touchstart',mousedown:'touchstart',mouseup:'touchend',mousemove:'touchmove',mouseout:'touchend'},navigator=window.navigator,supportsTouch='ontouchstart'in document||navigator.maxTouchPoints||navigator.msMaxTouchPoints,supportsPointer='onpointerover'in document,fcClick=function(a,b,c=a){var d,e,f,g,h;if(!a._clickHandlerHelper){let b=function(b){a._lastEventTriggered='mousedown',f=void 0===b.clientX?b.changedTouches&&b.changedTouches[0].clientX:b.clientX,g=void 0===b.clientY?b.changedTouches&&b.changedTouches[0].clientY:b.clientY},c=function(b){var c=Math.abs;let d=void 0===b.clientX?b.changedTouches&&b.changedTouches[0].clientX:b.clientX,e=void 0===b.clientY?b.changedTouches&&b.changedTouches[0].clientY:b.clientY;(2.5<=c(f-d)||2.5<=c(g-e))&&(a._lastEventTriggered=void 0)};for(d in h=!supportsPointer&&supportsTouch?{touchstart:function(){a._lastEventTriggered='touchstart',a._lastEventTriggeredAt=new Date().getTime()},touchmove:c}:supportsPointer&&supportsTouch?{pointerdown:b,pointermove:c}:{mousedown:b,mousemove:c},h)a.addEventListener?a.addEventListener(d,h[d]):a.attachEvent('on'+d,h[d]);a._clickHandlerHelper=h,a._clickEventCount=0}return++a._clickEventCount,!supportsPointer&&supportsTouch?(d='touchend',e=function(d){'touchstart'===a._lastEventTriggered&&500>=new Date().getTime()-a._lastEventTriggeredAt&&setTimeout(function(){b.call(c,d)},0)}):(d='click',e=function(d){'mousedown'===a._lastEventTriggered&&b.call(c,d)}),{[d]:e}},fcunclick=function(a){var b,c=a._clickHandlerHelper;if(! --a._clickEventCount){for(b in c)a.removeEventListener?a.removeEventListener(b,c[b]):a.detachEvent('on'+b,c[b]);a._clickHandlerHelper=void 0}},getDerivedInfo=function(a,b,c,d=a){switch(b){case'fc-click':return fcClick(a,c);}var e,f=b.match(/fc-/),g=c;return f&&(b=b.replace(/fc-/,'')),f&&supportsTouch&&(e=b,b=(supportsPointer?safePointerEventMapping[b]:safeMouseEventMapping[b])||b,'mouseout'===e&&(g=function(a){supportsPointer&&supportsTouch&&!a.isPrimary||(lastHoveredInfo.elementInfo.push({el:d,callback:c}),lastHoveredInfo.srcElement=a.srcElement||a.target)},b=supportsPointer?'pointerover':'touchstart')),g===c&&(g=function(a){supportsPointer&&supportsTouch&&!a.isPrimary||c.call(d,a)}),{[b]:g}},removeHelperHandlers=function(a,b){return'fc-click'===b?fcunclick(a):void 0};supportsTouch&&document.addEventListener(supportsPointer?'pointerover':'touchstart',function(a){if(lastHoveredInfo.srcElement&&lastHoveredInfo.srcElement!==(a.srcElement||a.target)){var b,c,d=lastHoveredInfo.elementInfo,e=d.length;for(c=0;c<e;c++)b=d[c],b.callback.call(b.el,a)}lastHoveredInfo={elementInfo:[]}},!0);class FusionEvenetHandler{constructor(){this.mapper=new Mapper}on(a,b,c,d={}){let e,f,g=this.mapper,h=[a,b,c];if(isAllDefined(h)&&!(e=g.getValue(h))){for(f in e=getDerivedInfo(a,b,c),g.setValue(h,e),e)a.addEventListener?a.addEventListener(f,e[f]):a.attachEvent('on'+f,e[f]);return!0}return!1}off(a,b,c){let d,e,f=this.mapper,g=[a,b,c];if(isAllDefined(g)&&(d=f.getValue(g))){for(e in removeHelperHandlers(a,b),d)a.removeEventListener?a.removeEventListener(e,d[e]):a.detachEvent('on'+e,d[e]);return f.clear(g),!0}return!1}}export default FusionEvenetHandler;